<%@ page contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="com.cnpc.jcdp.soa.msg.ISrvMsg"%>
<%@ page import="java.util.*"%>
<%@ page import="com.cnpc.jcdp.soa.msg.MsgElement"%>
<%@page import="com.cnpc.jcdp.common.UserToken"%>
<%@page import="com.cnpc.jcdp.webapp.util.OMSMVCUtil"%>
<%@taglib prefix="auth" uri="auth"%>
<%
	String contextPath = request.getContextPath();
	UserToken user = OMSMVCUtil.getUserToken(request);
	String projectName = user.getProjectName();
	if(projectName==null){
		projectName = "";
	}
	ISrvMsg resultMsg = OMSMVCUtil.getResponseMsg(request);
	String report_id = request.getParameter("report_id");
	if(report_id==null){
		report_id = "";
	}
	String org_id = user.getOrgId();
	if(org_id==null || org_id.trim().equals("")){
		org_id = "";
	}
	String org_subjection_id = user.getSubOrgIDofAffordOrg();
	if(org_subjection_id==null || org_subjection_id.trim().equals("")){
		org_subjection_id = "";
	}
	String user_id = user.getUserId();
	String project_info_no = user.getProjectInfoNo();
	String project_type = user.getProjectType();
	if(project_type!=null && project_type.trim().equals("5000100004000000002")){
		project_type = "5000100004000000010";
	}
	String spare5 = "1";
	String display = "block";
	if(project_type.trim().equals("5000100004000000009")){
		spare5= "2";
		display = "none";
	}
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head> 
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
		<link href="<%=contextPath%>/css/calendar-blue.css" rel="stylesheet" type="text/css" />
		<link href="<%=contextPath%>/styles/style.css" rel="stylesheet" type="text/css" />
		<link href="<%=contextPath%>/styles/SpryTabbedPanels3.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="<%=contextPath%>/js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="<%=contextPath%>/js/dialog_open.js"></script>
		<script type="text/javascript" src="<%=contextPath%>/js/rt/rt_base.js"></script>
		<script type="text/javascript" src="<%=contextPath%>/js/gms_list.js"></script>
		<script type="text/javascript" src="<%=contextPath%>/js/calendar.js"></script>
		<script type="text/JavaScript" src="<%=contextPath%>/js/calendar-zh.js"></script>
		<script type="text/javascript" src="<%=contextPath%>/js/calendar-setup.js"></script>
	</head> 
<body><!-- class="bgColor_f3f3f3"  onload="page_init()"> --> 
<form name="fileForm" id="fileForm" method="post" > <!--target="hidden_frame" enctype="multipart/form-data" --> 
	<div id="new_table_box" align="center">
		<div id="new_table_box_content"> 
			<div id="new_table_box_bg">
				<table width="100%"  border="0" cellspacing="0" cellpadding="0" class="tab_line_height">
					<input type="hidden" name="report_id" id="report_id" value="<%=report_id %>" class="input_width" />
					<tr>
					    <td class="inquire_item4">质量分析报告:</td>
					    <td class="inquire_form4" ><input type="text" name="" id="" value="质量分析报告" class="input_width" disabled="disabled" /></td>
					   	<td class="inquire_item4">报告序列号:</td>
					    <td class="inquire_form4" ><input type="text" name="report_code" id="report_code" value="BGP/Q/JL8.2.4-5" class="input_width"/></td>
					</tr>
					<tr>   	
					   	<td class="inquire_item4">编号:</td>
					   	<td class="inquire_form4"><input type="text" name="report_num" id="report_num" value="" class="input_width" /></td>
					    <td class="inquire_item4"><font color="red">*</font>时间:</td>
					    <td class="inquire_form4" ><input type="text" name="report_date" id="report_date" value="" class="input_width" disabled="disabled"/>
					    <img width="16" height="16" id="cal_button6" style="cursor: hand;" 
	    					onmouseover="calDateSelector(report_date,cal_button6);" src="<%=contextPath %>/images/calendar.gif" /></td>
	    			</tr>
					<tr>
						<td class="inquire_item4">施工工区:</td>
					   	<td class="inquire_form4"><input type="text" name="work_area" id="work_area" value="" class="input_width" /></td>
						<td class="inquire_item4">线束号:</td>
					   	<td class="inquire_form4"><input type="text" name="line_num" id="line_num" value="" class="input_width" /></td>
				  	</tr>
					<tr>	
				  		<td class="inquire_item4">主持人:</td>
					    <td class="inquire_form4" ><input type="text" name="master_id" id="master_id" value="" class="input_width" /></td> 
						<td class="inquire_item4">记录人:</td>
					    <td class="inquire_form4" ><input type="text" name="record_id" id="record_id" value="" class="input_width" /></td> 
					</tr>
					<tr>
						<td class="inquire_item4">设计工作量:</td>
					   	<td class="inquire_form4"><input type="text" name="design_work" id="design_work" value="" class="input_width" 
					   		onkeydown="javascript:return checkIfNum(event);"/></td>
					   	<td class="inquire_item4">实际完成工作量:</td>
					   	<td class="inquire_form4"><input type="text" name="complete_work" id="complete_work" value="" class="input_width" 
					   		onkeydown="javascript:return checkIfNum(event);"/></td>
					</tr>
					<tr>
						<td class="inquire_item4"><%if(project_type.trim().equals("5000100004000000009")){%>现场施工:<%}else{ %>表层调查:<%} %></td>
						<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="surface" name="surface" class="textarea"></textarea></td>
					</tr>
					<tr>
					   	<td class="inquire_item4"><%if(project_type.trim().equals("5000100004000000009")){%>室内计算:<%}else{ %>激发因素:<%} %></td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="stimulate" name="stimulate" class="textarea"></textarea></td>
					</tr>
					<tr>	
						<td class="inquire_item4">技术措施:</td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="technology" name="technology" class="textarea"></textarea></td>
					</tr>
					<tr>
						<td class="inquire_item4"><div>质量管</div>理措施:</td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="manage_step" name="manage_step" class="textarea"></textarea></td>
					</tr>
					<tr>	
						<td class="inquire_item4">原始资料点评:</td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="original_data" name="original_data" class="textarea"></textarea></td>
					</tr>
					<tr style="display: <%=display%>;">
						<td class="inquire_item4"><div>现场处理&nbsp;</div>剖面评价:</td>
					   	<td class="inquire_form4"colspan=3" ><textarea cols="" rows="" id="sections" name="sections" class="textarea"></textarea></td>
					</tr>
					<tr>	
						<td class="inquire_item4">存在问题:</td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="proplem" name="proplem" class="textarea"></textarea></td>
					</tr>
					<tr>
						<td class="inquire_item4"><div>下一步解决</div> <div>问题的措施:</div></td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="next_step" name="next_step" class="textarea"></textarea></td>
					</tr>
					<tr>
						<td class="inquire_item4">质量监督员:</td>
					   	<td class="inquire_form4" colspan=3"><textarea cols="" rows="" id="supervise" name="supervise" class="textarea"></textarea></td>
					</tr>
					<tr>
						<td class="inquire_item4">备注:</td>
					    <td class="inquire_form4" colspan=3"><textarea rows="4" cols="10" id="note" name="note" class="textarea"></textarea></td>
					</tr>
				</table>
			</div> 
			<div id="oper_div">
					<span class="bc_btn"><a href="#" onclick="newSubmit()"></a></span>
					<span class="gb_btn"><a href="#" onclick="newClose()"></a></span>
			</div>
		</div>
	</div>
</form> 
<script type="text/javascript">
	cruConfig.contextPath = '<%=contextPath%>';
	/* 输入的是否是数字 */
	function checkIfNum(){
		var element = event.srcElement;
		if(element.value != null && element.value =='0' && (event.keyCode>=48 && event.keyCode<=57)){
			element.value = '';
		}
		if((event.keyCode>=48 && event.keyCode<=57) || event.keyCode ==8 || event.keyCode ==37 || event.keyCode ==39 || event.keyCode ==9){
			return true;
		}
		else{
			alert("只能输入数字");
			return false;
		}
	}
	function refreshData(){
		var report_id = '<%=report_id%>';
		var sql = "select t.report_id ,t.report_code ,t.report_num ,t.report_date ,t.work_area ,t.line_num ,"+
		" t.master_id ,t.record_id ,t.design_work ,t.complete_work ,t.surface ,t.stimulate ,t.technology ,"+
		" t.manage_step ,t.original_data ,t.sections ,t.proplem ,t.next_step ,t.supervise ,t.note"+
		" from bgp_qua_meeting_report t "+
		" where t.bsflag='0' and t.report_id ='"+report_id+"'";
		
		var retObj = syncRequest('Post',cruConfig.contextPath + appConfig.queryListAction,'querySql='+encodeURI(encodeURI(sql)));
		if(retObj!=null && retObj.returnCode =='0'){
			if(retObj.datas!=null && retObj.datas.length>0){
				if(retObj.datas[0]!=null){
					var map = retObj.datas[0];
					document.getElementById("report_id").value = report_id;
					document.getElementById("report_code").value = map.report_code;
					document.getElementById("report_num").value = map.report_num;
					document.getElementById("report_date").value = map.report_date;
					document.getElementById("work_area").value = map.work_area;
					document.getElementById("line_num").value = map.line_num;
					document.getElementById("master_id").value = map.master_id;
					document.getElementById("record_id").value = map.record_id;
					document.getElementById("design_work").value = map.design_work;
					document.getElementById("complete_work").value = map.complete_work;
					document.getElementById("surface").value = map.surface;
					document.getElementById("stimulate").value = map.stimulate;
					document.getElementById("technology").value = map.technology;
					document.getElementById("manage_step").value = map.manage_step;
					document.getElementById("original_data").value = map.original_data;
					document.getElementById("sections").value = map.sections;
					document.getElementById("proplem").value = map.proplem;
					document.getElementById("next_step").value = map.next_step;
					document.getElementById("supervise").value = map.supervise;
					document.getElementById("note").value = map.note;
				}
			}
		}
	}
	refreshData();
	function newSubmit() {
		if(checkValue() == false){
			return ;
		}
		var org_id = '<%=org_id%>';
		var org_subjection_id = '<%=org_subjection_id%>';
		var user_id = '<%=user_id%>';
		var project_info_no = '<%=project_info_no%>';
		var org_id = '<%=org_id%>';
		var report_id = document.getElementById("report_id").value ;
		var report_code = document.getElementById("report_code").value ;
		var report_num = document.getElementById("report_num").value ;
		var report_date = document.getElementById("report_date").value 
		var work_area = document.getElementById("work_area").value ;
		var line_num = document.getElementById("line_num").value ;
		var master_id = document.getElementById("master_id").value ;
		var record_id = document.getElementById("record_id").value ;
		var design_work = document.getElementById("design_work").value ;
		var complete_work = document.getElementById("complete_work").value ;
		var surface = document.getElementById("surface").value ;
		var stimulate = document.getElementById("stimulate").value ;
		var technology = document.getElementById("technology").value ;
		var manage_step = document.getElementById("manage_step").value ;
		var original_data = document.getElementById("original_data").value ;
		var sections = document.getElementById("sections").value ;
		var proplem = document.getElementById("proplem").value ;
		var next_step = document.getElementById("next_step").value ;
		var supervise = document.getElementById("supervise").value ;
		var note = document.getElementById("note").value ;
		var substr = '';
		if(report_id==null || report_id==''){
			substr = "insert into bgp_qua_meeting_report(report_id ,report_code ,report_num ,report_date ,work_area ,line_num ,master_id ,record_id ,"+
			" design_work ,complete_work ,surface ,stimulate ,technology ,manage_step ,original_data ,sections ,proplem ,next_step ,note ,supervise ,"+
			" project_info_no ,org_id ,org_subjection_id ,bsflag ,creator_id ,create_date ,updator_id ,modifi_date) " +
			" values((select lower(sys_guid()) from dual),'"+report_code+"','"+report_num+"',to_date('"+report_date+"','yyyy-MM-dd'),'"+work_area+"','"+line_num+"',"+
			" '"+master_id+"','"+record_id+"','"+design_work+"','"+complete_work+"','"+surface+"','"+stimulate+"','"+technology+"','"+manage_step+"',"+
			" '"+original_data+"','"+sections+"','"+proplem+"','"+next_step+"','"+supervise+"','"+note+"','"+project_info_no+"','"+org_id+"','"+org_subjection_id+"','0',"+
			" '"+user_id+"',sysdate,'"+user_id+"',sysdate);";
			retObj = jcdpCallService("QualitySrv", "saveQualityBySql", "sql="+substr);
		}else{
			substr = "update bgp_qua_meeting_report t set t.report_id ='"+report_id+"' ,t.report_code ='"+report_code+"' ,t.report_num ='"+report_num+"' ,"+
			" t.report_date =to_date('"+report_date+"','yyyy-MM-dd') ,t.work_area ='"+work_area+"' ,t.line_num ='"+line_num+"' ,t.master_id ='"+master_id+"' ,"+
			" t.record_id ='"+record_id+"' ,t.design_work ='"+design_work+"' ,t.complete_work ='"+complete_work+"' ,t.surface ='"+surface+"' ,"+
			" t.stimulate ='"+stimulate+"' ,t.technology ='"+technology+"' ,t.manage_step ='"+manage_step+"' ,t.original_data ='"+original_data+"' ,"+
			" t.sections ='"+sections+"' ,t.proplem ='"+proplem+"' ,t.next_step ='"+next_step+"' ,t.supervise='"+supervise+"' ,t.note='"+note+"' ,t.org_id='"+org_id+"' ,"+
			" t.org_subjection_id='"+org_subjection_id+"',t.updator_id ='"+user_id+"',t.modifi_date=sysdate where t.report_id ='"+report_id+"';";
			retObj = jcdpCallService("QualitySrv", "saveQualityBySql", "sql="+substr);
		}
		if(retObj!=null && retObj.returnCode=='0'){
			alert("保存成功!")
			var ctt = top.frames('list');
			ctt.refreshData();
			newClose();
			
		}
	}
	function checkValue(){
		var obj = document.getElementById("report_date");
		value = obj.value ;
		if(obj ==null || value==''){
			alert("时间不能为空!");
			return false;
		}
	}
	function selectOrgHR(select_type , select_id , select_name){
	    var teamInfo = {
	        fkValue:"",
	        value:""
	    };
	    window.showModalDialog('<%=contextPath%>/common/selectOrgHR.jsp?select='+select_type,teamInfo);
	    if(teamInfo.fkValue!=""){
	        document.getElementById(select_id).value = teamInfo.fkValue;
	        document.getElementById(select_name).value = teamInfo.value;
	    }
	}
</script>
</body>
</html>